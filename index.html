<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Primary SEO -->
    <title>PerspectiveFix – Free Online Perspective Image Correction Tool</title>
    <meta name="description"
        content="PerspectiveFix is a free online perspective correction tool. Fix skewed documents, photos, book pages, whiteboards, and scanned images directly in your browser. No upload. No watermark.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://oathanrex.github.io/perspective-fix/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="PerspectiveFix – Free Online Perspective Image Correction Tool">
    <meta property="og:description"
        content="Fix skewed images and documents online with PerspectiveFix. 100% browser-based, private, and watermark-free.">
    <meta property="og:url" content="https://oathanrex.github.io/perspective-fix/">
    <meta property="og:image" content="https://oathanrex.github.io/perspective-fix/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PerspectiveFix – Free Perspective Correction Tool">
    <meta name="twitter:description"
        content="Correct perspective distortion in images online. No download. No watermark.">
    <meta name="twitter:image" content="https://oathanrex.github.io/perspective-fix/og-image.png">

    <!-- Favicon -->
    <link rel="apple-touch-icon" href="favicon-512.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png">

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --primary-dark: #065f46;
            --primary-light: #d1fae5;
            --accent: #0d9488;
        }

        .corner-handle {
            width: 24px;
            height: 24px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            position: absolute;
            cursor: grab;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 100;
            transition: transform 0.1s, background 0.1s;
        }

        .corner-handle:hover {
            background: var(--primary-hover);
            transform: translate(-50%, -50%) scale(1.2);
        }

        .corner-handle:active {
            cursor: grabbing;
            background: var(--primary-dark);
        }

        .corner-handle::after {
            content: attr(data-label);
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }

        .drop-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s;
        }

        .drop-zone:hover {
            border-color: var(--primary);
        }

        .drop-zone.drag-over {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .canvas-container {
            position: relative;
            display: inline-block;
        }

        #mainCanvas,
        #previewCanvas {
            max-width: 100%;
            max-height: 60vh;
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .quad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .compare-container {
            position: relative;
            display: inline-block;
            line-height: 0;
            overflow: hidden;
        }

        .compare-after {
            display: block;
        }

        .compare-before {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .slider-container {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: white;
            cursor: ew-resize;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }

        .slider-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .compare-label {
            position: absolute;
            bottom: 10px;
            padding: 4px 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
        }

        .compare-label.before {
            left: 10px;
        }

        .compare-label.after {
            right: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .icon-box {
            background: var(--primary-light);
        }

        .icon-box svg {
            color: var(--primary);
        }

        .use-case-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-light) 0%, #ccfbf1 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
        }

        .use-case-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--primary);
        }

        @media (max-width: 768px) {
            .corner-handle {
                width: 32px;
                height: 32px;
            }
        }
    </style>
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "PerspectiveFix",
  "applicationCategory": "ImageEditingApplication",
  "operatingSystem": "Any",
  "url": "https://oathanrex.github.io/perspective-fix/",
  "description": "Free online perspective image correction tool to fix skewed photos, documents, book pages, and scans directly in your browser.",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>

</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">PerspectiveFix</h1>
                    <p class="text-xs text-gray-500">Free Perspective Correction</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="#how-it-works" class="text-sm text-gray-600 hover:text-emerald-600 hidden sm:block">How it
                    works</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Hero Section (shown when no image) -->
        <section id="heroSection" class="text-center mb-8">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">Free Online Perspective Image Correction Tool
            </h2>
            <p class="text-lg text-gray-600 mb-2">Transform distorted images into perfect rectangles in seconds.</p>
            <p class="text-sm text-gray-500 max-w-2xl mx-auto">Fix skewed documents, architectural photos, book pages,
                whiteboards, and more. No downloads. No watermark. Your images never leave your device.</p>
        </section>

        <!-- Upload Zone -->
        <div id="uploadZone" class="drop-zone rounded-2xl p-12 text-center bg-white mb-6 cursor-pointer transition-all">
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" class="hidden">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="text-lg font-medium text-gray-700 mb-1">Drop your image here or click to upload</p>
                <p class="text-sm text-gray-500">Supports JPG, PNG, WEBP</p>
            </div>
        </div>

        <!-- Editor Section -->
        <section id="editorSection" class="hidden">
            <!-- Toolbar -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-2">
                        <button id="uploadNewBtn"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            New Image
                        </button>
                        <button id="resetBtn"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reset Points
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                            <input type="checkbox" id="gridToggle"
                                class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                            Show Grid
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                            <input type="checkbox" id="livePreviewToggle" checked
                                class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                            Live Preview
                        </label>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="zoomOutBtn" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                            title="Zoom Out">
                            <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
                            </svg>
                        </button>
                        <span id="zoomLevel" class="text-sm text-gray-600 min-w-[50px] text-center">100%</span>
                        <button id="zoomInBtn" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                            title="Zoom In">
                            <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                            </svg>
                        </button>
                        <button id="zoomFitBtn" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                            title="Fit to Screen">
                            <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- Original Image -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <h3 class="font-medium text-gray-700">Original - Adjust Corner Points</h3>
                    </div>
                    <div class="p-4 overflow-auto" id="originalContainer" style="max-height: 65vh;">
                        <div class="canvas-container inline-block relative" id="canvasWrapper">
                            <canvas id="mainCanvas"></canvas>
                            <svg id="quadOverlay" class="quad-overlay"></svg>
                            <canvas id="gridCanvas" class="grid-overlay hidden"></canvas>
                            <div id="cornerHandles"></div>
                        </div>
                    </div>
                </div>

                <!-- Preview -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="font-medium text-gray-700">Corrected Preview</h3>
                        <div class="flex gap-1">
                            <button id="tabSideBySide" class="tab-btn px-3 py-1 text-xs rounded-md active">Side by
                                Side</button>
                            <button id="tabCompare"
                                class="tab-btn px-3 py-1 text-xs rounded-md bg-gray-200 hover:bg-gray-300">Compare</button>
                        </div>
                    </div>
                    <div class="p-4 overflow-auto" id="previewContainer" style="max-height: 65vh;">
                        <div id="sideBySideView">
                            <canvas id="previewCanvas"></canvas>
                        </div>
                        <div id="compareView" class="hidden">
                            <div class="compare-container" id="compareContainer">
                                <canvas id="compareAfterCanvas" class="compare-after"></canvas>
                                <canvas id="compareBeforeCanvas" class="compare-before"></canvas>
                                <span class="compare-label before">Original</span>
                                <span class="compare-label after">Corrected</span>
                                <div id="compareSlider" class="slider-container">
                                    <div class="slider-handle">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <label class="text-sm text-gray-600">Output Format:</label>
                        <select id="formatSelect"
                            class="rounded-lg border-gray-300 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="png">PNG (Lossless)</option>
                            <option value="jpeg">JPEG (Smaller)</option>
                            <option value="webp">WebP (Modern)</option>
                        </select>
                        <div id="qualityContainer" class="hidden items-center gap-2">
                            <label class="text-sm text-gray-600">Quality:</label>
                            <input type="range" id="qualitySlider" min="10" max="100" value="92"
                                class="w-24 accent-emerald-600">
                            <span id="qualityValue" class="text-sm text-gray-600">92%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="applyBtn"
                            class="px-6 py-2.5 btn-primary rounded-lg font-medium transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            Apply Correction
                        </button>
                        <button id="downloadBtn"
                            class="px-6 py-2.5 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Info -->
            <div id="imageInfo" class="mt-4 text-center text-sm text-gray-500"></div>
        </section>

        <!-- How it Works Section -->
        <section id="how-it-works" class="mt-16 mb-12">
            <h2 class="text-2xl font-bold text-gray-900 text-center mb-8">How It Works</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-emerald-600">1</span>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Upload Image</h3>
                    <p class="text-sm text-gray-600">Drag & drop or click to upload your distorted image.</p>
                </div>
                <div class="text-center">
                    <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-emerald-600">2</span>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Adjust Corners</h3>
                    <p class="text-sm text-gray-600">Drag the four corner points to match the distorted shape.</p>
                </div>
                <div class="text-center">
                    <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-emerald-600">3</span>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Preview Result</h3>
                    <p class="text-sm text-gray-600">See the corrected image update in real-time as you adjust.</p>
                </div>
                <div class="text-center">
                    <div class="w-14 h-14 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-emerald-600">4</span>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Download</h3>
                    <p class="text-sm text-gray-600">Save your perfectly corrected image at full resolution.</p>
                </div>
            </div>
        </section>

        <!-- Use Cases -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 text-center mb-8">Perfect For</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-200">
                    <div class="use-case-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Documents</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-200">
                    <div class="use-case-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Architecture</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-200">
                    <div class="use-case-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Book Pages</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-200">
                    <div class="use-case-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Whiteboards</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-200">
                    <div class="use-case-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Posters</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-200">
                    <div class="use-case-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Screens</p>
                </div>
            </div>
        </section>

        <!-- Features -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 text-center mb-8">Why Choose PerspectiveFix?</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">100% Private</h3>
                    <p class="text-sm text-gray-600">Your images never leave your device. All processing happens locally
                        in your browser.</p>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">Lightning Fast</h3>
                    <p class="text-sm text-gray-600">No uploads or downloads to servers. Get instant results with
                        real-time preview.</p>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">High Quality</h3>
                    <p class="text-sm text-gray-600">Export at original resolution with no compression loss. No
                        watermarks ever.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-600 text-sm">PerspectiveFix - Free Online Perspective Correction Tool</p>
            <p class="text-gray-400 text-xs mt-2">Your images are processed entirely in your browser. We never see,
                store, or access your files.</p>
        </div>
    </footer>

    <script>
        // State
        var originalImage = null;
        var displayScale = 1;
        var zoom = 1;
        var corners = [];
        var isDragging = false;
        var draggedCorner = null;
        var correctedImageData = null;
        var isSliderDragging = false;

        // DOM Elements
        var uploadZone = document.getElementById('uploadZone');
        var fileInput = document.getElementById('fileInput');
        var heroSection = document.getElementById('heroSection');
        var editorSection = document.getElementById('editorSection');
        var mainCanvas = document.getElementById('mainCanvas');
        var mainCtx = mainCanvas.getContext('2d');
        var previewCanvas = document.getElementById('previewCanvas');
        var previewCtx = previewCanvas.getContext('2d');
        var gridCanvas = document.getElementById('gridCanvas');
        var gridCtx = gridCanvas.getContext('2d');
        var quadOverlay = document.getElementById('quadOverlay');
        var cornerHandles = document.getElementById('cornerHandles');
        var canvasWrapper = document.getElementById('canvasWrapper');

        // Buttons
        var resetBtn = document.getElementById('resetBtn');
        var uploadNewBtn = document.getElementById('uploadNewBtn');
        var applyBtn = document.getElementById('applyBtn');
        var downloadBtn = document.getElementById('downloadBtn');
        var gridToggle = document.getElementById('gridToggle');
        var livePreviewToggle = document.getElementById('livePreviewToggle');
        var zoomInBtn = document.getElementById('zoomInBtn');
        var zoomOutBtn = document.getElementById('zoomOutBtn');
        var zoomFitBtn = document.getElementById('zoomFitBtn');
        var zoomLevel = document.getElementById('zoomLevel');
        var formatSelect = document.getElementById('formatSelect');
        var qualityContainer = document.getElementById('qualityContainer');
        var qualitySlider = document.getElementById('qualitySlider');
        var qualityValue = document.getElementById('qualityValue');
        var imageInfo = document.getElementById('imageInfo');

        // Compare view elements
        var tabSideBySide = document.getElementById('tabSideBySide');
        var tabCompare = document.getElementById('tabCompare');
        var sideBySideView = document.getElementById('sideBySideView');
        var compareView = document.getElementById('compareView');
        var compareContainer = document.getElementById('compareContainer');
        var compareBeforeCanvas = document.getElementById('compareBeforeCanvas');
        var compareAfterCanvas = document.getElementById('compareAfterCanvas');
        var compareSlider = document.getElementById('compareSlider');

        // Event Listeners
        uploadZone.addEventListener('click', function () { fileInput.click(); });
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        resetBtn.addEventListener('click', resetCorners);
        uploadNewBtn.addEventListener('click', function () {
            fileInput.value = '';
            fileInput.click();
        });
        applyBtn.addEventListener('click', applyCorrection);
        downloadBtn.addEventListener('click', downloadImage);

        gridToggle.addEventListener('change', toggleGrid);
        livePreviewToggle.addEventListener('change', function () {
            if (livePreviewToggle.checked) {
                updatePreview();
            }
        });

        zoomInBtn.addEventListener('click', function () { setZoom(zoom + 0.25); });
        zoomOutBtn.addEventListener('click', function () { setZoom(zoom - 0.25); });
        zoomFitBtn.addEventListener('click', function () { setZoom(1); });

        formatSelect.addEventListener('change', function () {
            if (formatSelect.value === 'png') {
                qualityContainer.classList.add('hidden');
                qualityContainer.classList.remove('flex');
            } else {
                qualityContainer.classList.remove('hidden');
                qualityContainer.classList.add('flex');
            }
        });

        qualitySlider.addEventListener('input', function () {
            qualityValue.textContent = qualitySlider.value + '%';
        });

        // Tab switching
        tabSideBySide.addEventListener('click', function () {
            tabSideBySide.classList.add('active');
            tabCompare.classList.remove('active');
            sideBySideView.classList.remove('hidden');
            compareView.classList.add('hidden');
        });

        tabCompare.addEventListener('click', function () {
            tabCompare.classList.add('active');
            tabSideBySide.classList.remove('active');
            compareView.classList.remove('hidden');
            sideBySideView.classList.add('hidden');
            updateCompareView();
        });

        // Compare slider events
        compareSlider.addEventListener('mousedown', function (e) {
            e.preventDefault();
            isSliderDragging = true;
        });

        compareSlider.addEventListener('touchstart', function (e) {
            e.preventDefault();
            isSliderDragging = true;
        }, { passive: false });

        document.addEventListener('mousemove', function (e) {
            if (isSliderDragging) {
                updateSliderPosition(e.clientX);
            }
        });

        document.addEventListener('touchmove', function (e) {
            if (isSliderDragging && e.touches && e.touches.length > 0) {
                e.preventDefault();
                updateSliderPosition(e.touches[0].clientX);
            }
        }, { passive: false });

        document.addEventListener('mouseup', function () {
            isSliderDragging = false;
        });

        document.addEventListener('touchend', function () {
            isSliderDragging = false;
        });

        function updateSliderPosition(clientX) {
            var container = document.getElementById('compareContainer');
            if (!container) return;

            var rect = container.getBoundingClientRect();
            if (rect.width === 0) return;

            var pos = ((clientX - rect.left) / rect.width) * 100;
            pos = Math.max(0, Math.min(100, pos));

            compareSlider.style.left = pos + '%';
            compareBeforeCanvas.style.clipPath = 'inset(0 ' + (100 - pos) + '% 0 0)';
        }

        // Functions
        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            var file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        }

        function handleFileSelect(e) {
            var file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        }

        function loadImage(file) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var img = new Image();
                img.onload = function () {
                    originalImage = img;
                    setupEditor();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setupEditor() {
            heroSection.classList.add('hidden');
            uploadZone.classList.add('hidden');
            editorSection.classList.remove('hidden');

            var container = document.getElementById('originalContainer');
            var maxWidth = container.clientWidth - 32;
            var maxHeight = window.innerHeight * 0.6;

            displayScale = Math.min(
                maxWidth / originalImage.width,
                maxHeight / originalImage.height,
                1
            );

            var displayWidth = originalImage.width * displayScale;
            var displayHeight = originalImage.height * displayScale;

            mainCanvas.width = displayWidth;
            mainCanvas.height = displayHeight;
            gridCanvas.width = displayWidth;
            gridCanvas.height = displayHeight;
            quadOverlay.style.width = displayWidth + 'px';
            quadOverlay.style.height = displayHeight + 'px';
            quadOverlay.setAttribute('width', displayWidth);
            quadOverlay.setAttribute('height', displayHeight);

            mainCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);

            resetCorners();

            imageInfo.textContent = 'Original: ' + originalImage.width + ' x ' + originalImage.height + ' px';

            correctedImageData = null;
            downloadBtn.disabled = false;

            zoom = 1;
            zoomLevel.textContent = '100%';
            canvasWrapper.style.transform = 'scale(1)';
        }

        function resetCorners() {
            var w = mainCanvas.width;
            var h = mainCanvas.height;
            var margin = Math.min(w, h) * 0.1;

            corners = [
                { x: margin, y: margin },
                { x: w - margin, y: margin },
                { x: w - margin, y: h - margin },
                { x: margin, y: h - margin }
            ];

            renderCornerHandles();
            updateQuadOverlay();
            if (livePreviewToggle.checked) {
                updatePreview();
            }
        }

        function renderCornerHandles() {
            var labels = ['TL', 'TR', 'BR', 'BL'];
            cornerHandles.innerHTML = '';

            for (var i = 0; i < corners.length; i++) {
                var corner = corners[i];
                var handle = document.createElement('div');
                handle.className = 'corner-handle';
                handle.setAttribute('data-label', labels[i]);
                handle.setAttribute('data-index', i.toString());
                handle.style.left = corner.x + 'px';
                handle.style.top = corner.y + 'px';

                handle.addEventListener('mousedown', startDrag);
                handle.addEventListener('touchstart', startDrag, { passive: false });

                cornerHandles.appendChild(handle);
            }
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            draggedCorner = parseInt(e.target.getAttribute('data-index'), 10);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
        }

        function drag(e) {
            if (!isDragging || draggedCorner === null) return;
            e.preventDefault();

            var rect = mainCanvas.getBoundingClientRect();
            var clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            var x = (clientX - rect.left) / zoom;
            var y = (clientY - rect.top) / zoom;

            x = Math.max(0, Math.min(mainCanvas.width, x));
            y = Math.max(0, Math.min(mainCanvas.height, y));

            corners[draggedCorner] = { x: x, y: y };

            var handle = cornerHandles.children[draggedCorner];
            handle.style.left = x + 'px';
            handle.style.top = y + 'px';

            updateQuadOverlay();

            if (livePreviewToggle.checked) {
                updatePreview();
                if (!compareView.classList.contains('hidden')) {
                    updateCompareView();
                }
            }
        }

        function stopDrag() {
            isDragging = false;
            draggedCorner = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('touchend', stopDrag);
        }

        function updateQuadOverlay() {
            var points = '';
            for (var i = 0; i < corners.length; i++) {
                points += corners[i].x + ',' + corners[i].y;
                if (i < corners.length - 1) points += ' ';
            }

            var linesHtml = '';
            for (var j = 0; j < corners.length; j++) {
                var next = corners[(j + 1) % 4];
                linesHtml += '<line x1="' + corners[j].x + '" y1="' + corners[j].y + '" x2="' + next.x + '" y2="' + next.y + '" stroke="#059669" stroke-width="2" stroke-dasharray="5,5"/>';
            }

            quadOverlay.innerHTML = '<polygon points="' + points + '" fill="rgba(5, 150, 105, 0.2)" stroke="#059669" stroke-width="2"/>' + linesHtml;
        }

        function toggleGrid() {
            if (gridToggle.checked) {
                gridCanvas.classList.remove('hidden');
                drawGrid();
            } else {
                gridCanvas.classList.add('hidden');
            }
        }

        function drawGrid() {
            var w = gridCanvas.width;
            var h = gridCanvas.height;
            gridCtx.clearRect(0, 0, w, h);
            gridCtx.strokeStyle = 'rgba(5, 150, 105, 0.3)';
            gridCtx.lineWidth = 1;

            var gridSize = 50;

            for (var x = gridSize; x < w; x += gridSize) {
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, h);
                gridCtx.stroke();
            }

            for (var y = gridSize; y < h; y += gridSize) {
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(w, y);
                gridCtx.stroke();
            }
        }

        function setZoom(newZoom) {
            zoom = Math.max(0.25, Math.min(3, newZoom));
            zoomLevel.textContent = Math.round(zoom * 100) + '%';
            canvasWrapper.style.transform = 'scale(' + zoom + ')';
            canvasWrapper.style.transformOrigin = 'top left';
        }

        function updatePreview() {
            if (!originalImage) return;

            var srcCorners = [];
            for (var i = 0; i < corners.length; i++) {
                srcCorners.push({
                    x: corners[i].x / displayScale,
                    y: corners[i].y / displayScale
                });
            }

            var width = Math.max(
                distance(srcCorners[0], srcCorners[1]),
                distance(srcCorners[3], srcCorners[2])
            );
            var height = Math.max(
                distance(srcCorners[0], srcCorners[3]),
                distance(srcCorners[1], srcCorners[2])
            );

            var previewScale = Math.min(400 / width, 400 / height, 1);
            var previewWidth = Math.round(width * previewScale);
            var previewHeight = Math.round(height * previewScale);

            if (previewWidth <= 0 || previewHeight <= 0) return;

            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;

            applyPerspectiveTransform(
                originalImage,
                previewCanvas,
                srcCorners,
                previewWidth,
                previewHeight
            );
        }

        function distance(p1, p2) {
            var dx = p2.x - p1.x;
            var dy = p2.y - p1.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function applyPerspectiveTransform(srcImage, destCanvas, srcCorners, destWidth, destHeight) {
            var destCtx = destCanvas.getContext('2d');

            var src = srcCorners;
            var dst = [
                { x: 0, y: 0 },
                { x: destWidth, y: 0 },
                { x: destWidth, y: destHeight },
                { x: 0, y: destHeight }
            ];

            var H = computeHomography(dst, src);

            if (!H) {
                console.error('Could not compute homography');
                return;
            }

            var tempCanvas = document.createElement('canvas');
            tempCanvas.width = srcImage.width;
            tempCanvas.height = srcImage.height;
            var tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(srcImage, 0, 0);

            var srcData = tempCtx.getImageData(0, 0, srcImage.width, srcImage.height);
            var destData = destCtx.createImageData(destWidth, destHeight);

            for (var y = 0; y < destHeight; y++) {
                for (var x = 0; x < destWidth; x++) {
                    var w = H[6] * x + H[7] * y + H[8];
                    var srcX = (H[0] * x + H[1] * y + H[2]) / w;
                    var srcY = (H[3] * x + H[4] * y + H[5]) / w;

                    var pixel = bilinearInterpolate(srcData, srcX, srcY);

                    var destIdx = (y * destWidth + x) * 4;
                    destData.data[destIdx] = pixel.r;
                    destData.data[destIdx + 1] = pixel.g;
                    destData.data[destIdx + 2] = pixel.b;
                    destData.data[destIdx + 3] = pixel.a;
                }
            }

            destCtx.putImageData(destData, 0, 0);
        }

        function bilinearInterpolate(imageData, x, y) {
            var w = imageData.width;
            var h = imageData.height;

            if (x < 0 || x >= w - 1 || y < 0 || y >= h - 1) {
                return { r: 255, g: 255, b: 255, a: 255 };
            }

            var x0 = Math.floor(x);
            var y0 = Math.floor(y);
            var x1 = x0 + 1;
            var y1 = y0 + 1;

            var dx = x - x0;
            var dy = y - y0;

            function getPixel(px, py) {
                var idx = (py * w + px) * 4;
                return {
                    r: imageData.data[idx],
                    g: imageData.data[idx + 1],
                    b: imageData.data[idx + 2],
                    a: imageData.data[idx + 3]
                };
            }

            var p00 = getPixel(x0, y0);
            var p10 = getPixel(x1, y0);
            var p01 = getPixel(x0, y1);
            var p11 = getPixel(x1, y1);

            return {
                r: Math.round((1 - dx) * (1 - dy) * p00.r + dx * (1 - dy) * p10.r + (1 - dx) * dy * p01.r + dx * dy * p11.r),
                g: Math.round((1 - dx) * (1 - dy) * p00.g + dx * (1 - dy) * p10.g + (1 - dx) * dy * p01.g + dx * dy * p11.g),
                b: Math.round((1 - dx) * (1 - dy) * p00.b + dx * (1 - dy) * p10.b + (1 - dx) * dy * p01.b + dx * dy * p11.b),
                a: Math.round((1 - dx) * (1 - dy) * p00.a + dx * (1 - dy) * p10.a + (1 - dx) * dy * p01.a + dx * dy * p11.a)
            };
        }

        function computeHomography(src, dst) {
            var A = [];
            var b = [];

            for (var i = 0; i < 4; i++) {
                var sx = src[i].x;
                var sy = src[i].y;
                var dx = dst[i].x;
                var dy = dst[i].y;

                A.push([sx, sy, 1, 0, 0, 0, -dx * sx, -dx * sy]);
                A.push([0, 0, 0, sx, sy, 1, -dy * sx, -dy * sy]);
                b.push(dx);
                b.push(dy);
            }

            var h = solveLinearSystem(A, b);

            if (!h) return null;

            return [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7], 1];
        }

        function solveLinearSystem(A, b) {
            var n = b.length;
            var augmented = [];
            var idx, col, row, maxRow, temp, factor, k, j;

            for (idx = 0; idx < n; idx++) {
                augmented[idx] = A[idx].slice();
                augmented[idx].push(b[idx]);
            }

            for (col = 0; col < n; col++) {
                maxRow = col;
                for (row = col + 1; row < n; row++) {
                    if (Math.abs(augmented[row][col]) > Math.abs(augmented[maxRow][col])) {
                        maxRow = row;
                    }
                }

                temp = augmented[col];
                augmented[col] = augmented[maxRow];
                augmented[maxRow] = temp;

                if (Math.abs(augmented[col][col]) < 1e-10) {
                    return null;
                }

                for (row = col + 1; row < n; row++) {
                    factor = augmented[row][col] / augmented[col][col];
                    for (k = col; k <= n; k++) {
                        augmented[row][k] -= factor * augmented[col][k];
                    }
                }
            }

            var x = [];
            for (idx = 0; idx < n; idx++) {
                x[idx] = 0;
            }

            for (idx = n - 1; idx >= 0; idx--) {
                x[idx] = augmented[idx][n];
                for (j = idx + 1; j < n; j++) {
                    x[idx] -= augmented[idx][j] * x[j];
                }
                x[idx] /= augmented[idx][idx];
            }

            return x;
        }

        function applyCorrection() {
            if (!originalImage) return;

            applyBtn.disabled = true;
            applyBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';

            setTimeout(function () {
                var srcCorners = [];
                for (var i = 0; i < corners.length; i++) {
                    srcCorners.push({
                        x: corners[i].x / displayScale,
                        y: corners[i].y / displayScale
                    });
                }

                var width = Math.round(Math.max(
                    distance(srcCorners[0], srcCorners[1]),
                    distance(srcCorners[3], srcCorners[2])
                ));
                var height = Math.round(Math.max(
                    distance(srcCorners[0], srcCorners[3]),
                    distance(srcCorners[1], srcCorners[2])
                ));

                if (width <= 0 || height <= 0) {
                    applyBtn.disabled = false;
                    applyBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Apply Correction';
                    return;
                }

                var outputCanvas = document.createElement('canvas');
                outputCanvas.width = width;
                outputCanvas.height = height;

                applyPerspectiveTransform(originalImage, outputCanvas, srcCorners, width, height);

                correctedImageData = outputCanvas;
                downloadBtn.disabled = false;

                var previewScale = Math.min(400 / width, 400 / height, 1);
                previewCanvas.width = Math.round(width * previewScale);
                previewCanvas.height = Math.round(height * previewScale);
                previewCtx.drawImage(outputCanvas, 0, 0, previewCanvas.width, previewCanvas.height);

                applyBtn.disabled = false;
                applyBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Apply Correction';

                imageInfo.textContent = 'Original: ' + originalImage.width + ' x ' + originalImage.height + ' px → Corrected: ' + width + ' x ' + height + ' px';

                if (!compareView.classList.contains('hidden')) {
                    updateCompareView();
                }
            }, 50);
        }

        function downloadImage() {
            // Agar correctedImageData nahi hai toh pehle apply karo
            if (!correctedImageData) {
                // Auto-apply correction before download
                applyAndDownload();
                return;
            }

            performDownload();
        }

        function applyAndDownload() {
            if (!originalImage) return;

            var srcCorners = [];
            for (var i = 0; i < corners.length; i++) {
                srcCorners.push({
                    x: corners[i].x / displayScale,
                    y: corners[i].y / displayScale
                });
            }

            var width = Math.round(Math.max(
                distance(srcCorners[0], srcCorners[1]),
                distance(srcCorners[3], srcCorners[2])
            ));
            var height = Math.round(Math.max(
                distance(srcCorners[0], srcCorners[3]),
                distance(srcCorners[1], srcCorners[2])
            ));

            if (width <= 0 || height <= 0) return;

            var outputCanvas = document.createElement('canvas');
            outputCanvas.width = width;
            outputCanvas.height = height;

            applyPerspectiveTransform(originalImage, outputCanvas, srcCorners, width, height);

            correctedImageData = outputCanvas;
            downloadBtn.disabled = false;

            performDownload();
        }

        function performDownload() {
            if (!correctedImageData) return;

            var format = formatSelect.value;
            var quality = qualitySlider.value / 100;

            var mimeType, extension;
            if (format === 'jpeg') {
                mimeType = 'image/jpeg';
                extension = 'jpg';
            } else if (format === 'webp') {
                mimeType = 'image/webp';
                extension = 'webp';
            } else {
                mimeType = 'image/png';
                extension = 'png';
            }

            var dataUrl;
            if (format === 'png') {
                dataUrl = correctedImageData.toDataURL(mimeType);
            } else {
                dataUrl = correctedImageData.toDataURL(mimeType, quality);
            }

            // Create link and append to body for better browser support
            var link = document.createElement('a');
            link.download = 'corrected-image.' + extension;
            link.href = dataUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup
            setTimeout(function () {
                document.body.removeChild(link);
            }, 100);
        }

        function updateCompareView() {
            if (!originalImage) return;

            var afterSource = correctedImageData || previewCanvas;

            if (!afterSource || afterSource.width === 0 || afterSource.height === 0) {
                return;
            }

            var maxSize = 400;

            var afterScale = Math.min(maxSize / afterSource.width, maxSize / afterSource.height, 1);
            var afterDisplayWidth = Math.round(afterSource.width * afterScale);
            var afterDisplayHeight = Math.round(afterSource.height * afterScale);

            var beforeScale = Math.min(maxSize / originalImage.width, maxSize / originalImage.height, 1);
            var beforeDisplayWidth = Math.round(originalImage.width * beforeScale);
            var beforeDisplayHeight = Math.round(originalImage.height * beforeScale);

            var containerWidth = Math.max(afterDisplayWidth, beforeDisplayWidth);
            var containerHeight = Math.max(afterDisplayHeight, beforeDisplayHeight);

            if (containerWidth === 0 || containerHeight === 0) {
                return;
            }

            compareBeforeCanvas.width = containerWidth;
            compareBeforeCanvas.height = containerHeight;
            compareAfterCanvas.width = containerWidth;
            compareAfterCanvas.height = containerHeight;

            var beforeCtx = compareBeforeCanvas.getContext('2d');
            var afterCtx = compareAfterCanvas.getContext('2d');

            beforeCtx.fillStyle = '#f3f4f6';
            afterCtx.fillStyle = '#f3f4f6';
            beforeCtx.fillRect(0, 0, containerWidth, containerHeight);
            afterCtx.fillRect(0, 0, containerWidth, containerHeight);

            var beforeX = Math.round((containerWidth - beforeDisplayWidth) / 2);
            var beforeY = Math.round((containerHeight - beforeDisplayHeight) / 2);
            var afterX = Math.round((containerWidth - afterDisplayWidth) / 2);
            var afterY = Math.round((containerHeight - afterDisplayHeight) / 2);

            beforeCtx.drawImage(originalImage, beforeX, beforeY, beforeDisplayWidth, beforeDisplayHeight);
            afterCtx.drawImage(afterSource, afterX, afterY, afterDisplayWidth, afterDisplayHeight);

            compareSlider.style.left = '50%';
            compareBeforeCanvas.style.clipPath = 'inset(0 50% 0 0)';
        }
    </script>
</body>

</html>